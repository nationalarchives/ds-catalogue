{% extends 'base.html' %}

{% from 'components/breadcrumbs/macro.html' import tnaBreadcrumbs %}
{% from 'components/button/macro.html' import tnaButton %}
{% from 'components/card/macro.html' import tnaCard %}
{% from 'components/checkboxes/macro.html' import tnaCheckboxes %}
{% from 'components/compound-filters/macro.html' import tnaCompoundFilters %}
{% from 'components/date-search/macro.html' import tnaDateSearch %}
{% from 'components/pagination/macro.html' import tnaPagination %}
{% from 'components/search-field/macro.html' import tnaSearchField %}
{% from 'components/secondary-navigation/macro.html' import tnaSecondaryNavigation %}
{% from 'components/select/macro.html' import tnaSelect %}
{% from 'components/skip-link/macro.html' import tnaSkipLink %}
{% from 'components/text-input/macro.html' import tnaTextInput %}

{%- from 'macros/global_alert_banners.html' import global_alert_banners -%}
{% from 'search/macros/filters/search_within.html' import search_within %}
{% from 'search/macros/filters/date_range.html' import date_range %}
{% from 'search/macros/filters/date_input.html' import date_input %}
{% from 'search/macros/filters/levels.html' import levels %}
{% from 'search/macros/filters/closure_statuses.html' import closure_statuses %}
{% from 'search/macros/filters/opening_date.html' import opening_date %}
{% from 'search/macros/filters/collections.html' import collections %}
{% from 'search/macros/filters/online.html' import online %}
{% from 'search/macros/filters/subjects.html' import subjects %}
{% from 'search/macros/filters/held_by.html' import held_by %}
{% from 'search/macros/search_results.html' import search_results %}

{%- set pageTitle = 'Catalogue search results' -%}
{%- set encodedQuery = request.GET.urlencode() | base64_encode -%}

{% block stylesheets %}
{{ super() }}
    <link rel="stylesheet" href="{{ static('catalogue-results.css') }}?v={{ app_config.BUILD_VERSION }}" media="screen,print">
{% endblock %}

{% block skipLink %}
{% if results %}
  {{ tnaSkipLink({
    'href': 'results',
    'text': 'Skip to results'
  }) }}


  {{ tnaSkipLink({
    'href': 'filter-panel',
    'text': 'Skip to search filters'
  }) }}
{% endif %}
{{ super() }}
{% endblock %}

{% block beforeContent %}
<div class="tna-background-accent">
  <div class="tna-container">
    <div class="tna-column tna-column--full">
      {{ tnaBreadcrumbs({
        'items': [
          {
            'text': 'Home',
            'href': '/'
          },
          {
            'text': 'Catalogue',
            'href': url('main:catalogue')
          }
        ],
        'structuredData': True,
        'classes': 'tna-!--padding-vertical-s'
      }) }}
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="tna-background-accent">
  {{ global_alert_banners(request, global_alert.global_alert, global_alert.mourning_notice) }}
</div>
<div class="tna-background-accent tna-!--padding-top-s">
  <div class="tna-container">
    <form id="search-form" method="get" class="tna-column tna-column--full">
      {{ tnaSearchField({
        'label': pageTitle,
        'headingLevel': 1,
        'headingSize': 'l',
        'id': 'search',
        'name':  form.fields.q.name,
        'value': form.fields.q.value
      }) }}
      <!-- <div class="tna-button-group tna-!--margin-top-xs">
        {{ tnaButton({
          'text': 'Start new search',
          'href': '?',
          'plain': True,
          'small': True
        }) }}
      </div> -->
      <input type="hidden" name="display" value="{{ request.GET.get('display') or 'list' }}">
      <input type="hidden" name="group" value="{{ request.GET.get('group') or bucket_keys.TNA }}">
    </form>
    <div class="tna-column tna-column-full">
      <a href="{{ url('main:catalogue') }}">Start new search</a>
    </div>
    <div class="tna-column tna-column--full">
      {{ tnaSecondaryNavigation({
        'title': 'Sections',
        'headingLevel': 2,
        'items': bucket_list.items,
        'noBottomBorder': True,
        'visuallyHideHeading': True,
        'classes': 'tna-!--margin-top-m etna-results-buckets'
      }) }}
    </div>
  </div>
</div>
<div class="tna-container">
  <div id="filter-panel" class="tna-column tna-column--width-1-4 tna-column--width-1-3-medium tna-column--full-small tna-column--full-tiny tna-!--margin-top-l">
  
    <div class="mobile-skip">
        <a href="#results" class="tna-button tna-button--medium tna-button--plain"><i class="fa-solid fa-arrow-down" aria-hidden="true"></i>Skip to search results</a>
    </div>


    <h2 class="tna-heading-l">Filters</h2>
    
    <div class="tna-button-group tna-!--margin-top-xs">
      {{ tnaButton({
        'text': 'Add Filters',
        'buttonElement': True,
        'small': False,
        'attributes': {
          'form': 'search-form',
          'id':'mobile-filters'
        }
      }) }}
    </div>
    {% if selected_filters %}
        <div class="tna-aside tna-aside--tight tna-background-accent-light tna-!--margin-top-s">
            <h3 class="tna-heading-m">Active filters {% if selected_filters %} ({{ selected_filters | length }}){% endif %}:</h3>
            {{ tnaCompoundFilters({
              'items': selected_filters,
              'removeAllHref': url('search:catalogue') + '?q=' + form.fields.q.value + '&display=' + (request.GET.get('display') or ''),
              'removeAllText': 'Reset filters',
              'classes': 'tna-!--margin-top-s'
            }) }}
        </div>
    {% endif %}

    {% if form.fields.group.value==bucket_keys.TNA %}
      {{ online(request) }}
      {# {{ search_within(request) }} #}
      {{ date_input(request, 'date', 'date', 'Filter by record date') }}
      {{ collections(request, form.fields['collection']) }}
      {{ subjects(request, subjects_ctx) }}
      {{ levels(request, form.fields['level']) }}
      {{ date_input(request, 'date', 'date', 'Filter by record opening date') }}
      {{ closure_statuses(request, form.fields['closure']) }}
    {% elif form.fields.group.value==bucket_keys.NON_TNA %}
      {{ search_within(request) }}
      {{ date_input(request, 'date', 'date', 'Filter by record date') }}
      {{ held_by(request, form.fields['held_by']) }}
    {% endif %}
    
    
  </div>
  {% if results %}
  <div id="results" class="tna-column tna-column--width-3-4 tna-column--width-2-3-medium tna-column--full-small tna-column--full-tiny tna-!--margin-top-l">
    <div class="tna-container tna-container--nested tna-!--padding-bottom-s">
      {% if stats %}
      <div class="tna-column tna-column--flex-1 tna-column--full-tiny tna-column--align-centre">Showing results {{ results_range.from | format_number }}â€“{{ results_range.to | format_number }} of {{ stats.total | format_number }}</div>
      {% endif %}
      <div class="tna-column tna-column--full-tiny tna-column--align-centre">
        {{ tnaSelect({
          'label': 'Sort by',
          'headingLevel': 2,
          'headingSize': 's',
          'id': 'sort',
          'name': form.fields.sort.name,
          'items': form.fields.sort.items,
          'selected': form.fields.sort.value,
          'formItemClasses': 'etna-results-sort-by',
          'formItemAttributes': {
            'id': 'sort-form-group'
          },
          'attributes': {
            'form': 'search-form'
          }
        }) }}
        <div class="tna-button-group tna-button-group--small tna-!--margin-top-xs">
          {{ tnaButton({
            'text': 'Apply',
            'buttonElement': True,
            'buttonType': 'submit',
            'small': True,
            'attributes': {
              'form': 'search-form'
            }
          }) }}
        </div>
      </div>
      <div class="tna-column tna-column--full-tiny etna-results-layout tna-column--align-centre">
        <h2 class="tna-visually-hidden">Results layout</h2>
        <div class="tna-button-group tna-button-group--small tna-!--no-margin-top">
          {{ tnaButton({
            'text': 'Display as list',
            'href': '?' + qs_replace_value(request.GET, 'display', 'list'),
            'icon': 'list',
            'iconOnly': True
          }) }}
          {{ tnaButton({
            'text': 'Display as grid',
            'href': '?' + qs_replace_value(request.GET, 'display', 'grid'),
            'icon': 'grip',
            'iconOnly': True
          }) }}
        </div>
      </div>
    </div>
    <h2 class="tna-visually-hidden">Results</h2>
    {{ search_results(request, results, encodedQuery) }}
  </div>
  <div class="tna-column tna-column--full tna-!--margin-top-l">
    {{ tnaPagination(pagination) }}
    {% if page >= 495 %}
    <p class="tna-!--align-centre tna-!--margin-top-xs"><small><strong>Only the first 10,000 results are shown, apply filters to narrow your search.</strong></small></p>
    {% endif %}
  </div>
  {% else %}
  <div class="tna-column tna-column--width-3-4 tna-column--width-2-3-medium tna-column--full-small tna-column--full-tiny tna-!--margin-top-l">
    <h2 class="tna-heading-xl">No results found</h2>
    <p>No results were found for your query.</p>
    <p>Try widening your search.</p>

    {# TODO: Error logging is temporary for demo and must be formalised #}
    {% if form.errors or form.non_field_errors %}
      <h4>Form Errors</h4>
      <dl class="tna-dl">
        <dt>Param/ErrorName</dt>
        <dd>Value</dd>
        {% for field, error in form.errors.items() %}
          <dt>{{ field }}</dt>
          <dd>{{ error.text }}</dd>
        {% endfor %}
        {% for error in form.non_field_errors %}
          <dt>NONFIELDERROR</dt>
          <dd>{{ error.text }}</dd>
        {% endfor %}
      </dl>
    {% endif %}
  </div>
  {% endif %}
  <section class="tna-column tna-column--full tna-!--hide-on-print tna-!--margin-top-l">
      <hr>
      <p>
        <a href="#top" class="tna-button tna-button--small tna-button--plain"><i class="fa-solid fa-arrow-up" aria-hidden="true"></i>Back to top</a>
      </p>
</section>  

</div>
{% endblock %}

{% block bodyEnd %}
{{ super() }}
    <script src="{{ static('catalogue-results.min.js') }}?v={{ app_config.BUILD_VERSION }}" defer></script>
{% endblock %}
