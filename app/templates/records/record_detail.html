{% extends "base.html" %}
{% extends "base.html" %}

{%- from 'macros/global_alert_banners.html' import global_alert_banners -%}
{% from 'records/macros/accordion.html' import etna_accordion %}
{% from 'records/macros/whats_this_about_sub_sub_series_or_above.html' import whats_this_about_sub_sub_series_or_above %}
{% from 'records/macros/whats_this_about_piece_or_item.html' import whats_this_about_piece_or_item %}
{% from 'records/macros/whats_this_about_sub_sub_series_or_above.html' import whats_this_about_sub_sub_series_or_above %}
{% from 'records/macros/whats_this_about_piece_or_item.html' import whats_this_about_piece_or_item %}
{% from 'records/macros/available_online.html' import available_online %}
{% from 'records/macros/available_in_person.html' import available_in_person %}
{% from 'records/macros/detail_fields.html' import detail_fields %}
{% from 'records/macros/hierarchy.html' import hierarchy %}
{% from 'records/macros/how_to_order.html' import how_to_order %}
{% from 'records/macros/series_information.html' import series_information %}
{% from 'records/macros/top_navigation.html' import top_navigation %}
{% from 'records/macros/related_records_block.html' import related_records_block %}
{% from 'records/macros/related_content_block.html' import related_content_block %}
{% from 'records/macros/content_warning.html' import content_warning %}

{%- set pageTitle = (record.clean_title_or_summary_title or '[No title]') | striptags -%}

{% block head %}
  {{ super() }}
  {# Analytics meta #}
  {% for property in analytics_data %}
    <meta name="tna_root:{{ property }}" content="{{ analytics_data[property] | none_to_empty_string() }}">
  {% endfor %}
  <link rel="canonical" href="{{ request.build_absolute_uri(url('records:details', kwargs={'id': record.id})) }}">
{% endblock head %}
{% endblock head %}

{% block stylesheets %}
{{ super() }}
    <link rel="stylesheet" href="{{ static('record-details.css') ~ '?v=' ~ app_config.BUILD_VERSION }}" media="screen,print">
{% endblock stylesheets %}
{% endblock stylesheets %}

{% block beforeContent %}
{{ top_navigation(record, request) }}
{% endblock beforeContent %}
{% endblock beforeContent %}

{% block content %}
{{ global_alert_banners(request, global_alert.global_alert, global_alert.mourning_notice) }}
<div class="tna-section tna-!--padding-top-{{ 's' if distressing_content else 'l' }}">
  <div class="tna-container">
    {{ content_warning(
        distressing_content,
        "This record may include content that reflects the trauma and distress experienced by those present during or affected by the event of the time"
      ) }}
    <div class="tna-column tna-column--width-2-3 tna-column--width-5-6-medium tna-column--full-small tna-column--full-tiny tna-!--padding-top-xs">
      <hgroup class="tna-hgroup-xl">
        <p class="tna-hgroup__supertitle">{{ record.level }}</p>
        <h1 class="tna-hgroup__title">{{ pageTitle }}</h1>
      </hgroup>

      <p>Catalogue reference: <strong class="reference">{{ record.reference_number }}</strong></p>

      {% if canonical %}
      <p>Canonical: {{ canonical }}</p>
      {% endif %}
    </div>
  </div>

  {% if record.is_tna and record.level in ["Series", "Division", "Department", "Sub-series", "Sub-sub-series"] %}
    {{ whats_this_about_sub_sub_series_or_above(record) }}
  {% if record.is_tna and record.level in ["Series", "Division", "Department", "Sub-series", "Sub-sub-series"] %}
    {{ whats_this_about_sub_sub_series_or_above(record) }}
  {% else %}
    <div class="tna-container">
      {{ whats_this_about_piece_or_item(record) }}
      
      {# Delivery options sections - will be progressively loaded #}
      {# TODO: Add error handling to show "Access information is unavailable" on failure #}
      <div id="available-online-container" class="tna-column tna-column--width-1-3 tna-column--full-small tna-column--full-tiny tna-!--margin-top-m">
        <div class="tna-aside tna-aside--tight tna-background-accent-light full-height-aside progressive-loading">
          <h2 class="tna-heading-m">Is it available online?</h2>
          <div class="loading-spinner" aria-live="polite" aria-busy="true">
            <span class="spinner"></span>
            <p>Loading...</p>
          </div>
        </div>
      </div>
      
      <div id="available-in-person-container" class="tna-column tna-column--width-1-3 tna-column--full-small tna-column--full-tiny tna-!--margin-top-m">
        <div class="tna-aside tna-aside--tight tna-background-accent-light full-height-aside progressive-loading">
          <h2 class="tna-heading-m">Can I see it in person?</h2>
          <div class="loading-spinner" aria-live="polite" aria-busy="true">
            <span class="spinner"></span>
            <p>Loading...</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {{ detail_fields(record, field_labels, request) }}

  <div class="tna-container tna-!--margin-top-m">
    <div class="tna-column tna-column--full tna-margin-top-m">
      {% set accordion_items = [] %}

      {# Placeholder for delivery options accordion item - will be added via JS #}
      <div id="delivery-options-accordion-placeholder"></div>

      {% if record.hierarchy_series %}
        {% set accordion_items = accordion_items + [{
          'title': 'Series information',
          'body': series_information(record)
        }] %}
      {% endif %}

      {% set accordion_items = accordion_items + [{
        'title': 'Catalogue hierarchy',
        'body': hierarchy(record)
      }] %}

      {{ etna_accordion({
        'accordionItems': accordion_items,
        'id': 'record-extended-details',
      }) }}

    </div>
  </div>
</div>

{# Related content block - progressively loaded #}
<div id="related-content-container" class="progressive-loading" aria-live="polite" aria-busy="true">
  <div class="tna-container">
    <div class="tna-column tna-column--full tna-!--margin-top-l">
      <div class="loading-spinner">
        <span class="spinner"></span>
        <p>Loading related content...</p>
      </div>
    </div>
  </div>
</div>

{# Related records block - progressively loaded #}
<div id="related-records-container" class="progressive-loading" aria-live="polite" aria-busy="true">
  <div class="tna-container">
    <div class="tna-column tna-column--full tna-!--margin-top-l">
      <div class="loading-spinner">
        <span class="spinner"></span>
        <p>Loading related records...</p>
      </div>
    </div>
  </div>
</div>

{# No-JS fallback #}
<noscript>
  <div class="tna-container tna-!--margin-top-l">
    <div class="tna-aside tna-aside--warning">
      <h2>JavaScript Required</h2>
      <p>This page requires JavaScript to load all content. Please enable JavaScript in your browser settings to view the complete record information including delivery options, related content, and related records.</p>
    </div>
  </div>
</noscript>

{# Hidden data for JavaScript #}
<script type="application/json" id="progressive-loading-config">
{
  "recordId": "{{ record.id }}",
  "shouldLoadDelivery": {% if record.level not in ["Series", "Division", "Department", "Sub-series", "Sub-sub-series"] %}true{% else %}false{% endif %},
  "endpoints": {
    "subjects": "{{ url('records:enrichment_subjects', kwargs={'id': record.id}) }}",
    "related": "{{ url('records:enrichment_related', kwargs={'id': record.id}) }}",
    "delivery": "{{ url('records:enrichment_delivery', kwargs={'id': record.id}) }}"
  }
}
</script>

{% endblock content %}

{% block bodyEnd %}
{{ super() }}
    <script src="{{ static('record-details.min.js') ~ '?v=' ~ app_config.BUILD_VERSION }}" defer></script>
{% endblock bodyEnd %}